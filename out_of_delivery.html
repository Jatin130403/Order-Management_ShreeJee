<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Out Of Delivery Orders â€” ShreeJee Ayucare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .order-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .order-card:hover { transform: translateY(-4px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
    .btn-blue { background:#2563eb; color:white; }
    .btn-green { background:#16a34a; color:white; }
    .btn-yellow { background:#ca8a04; color:white; }
    .btn-red { background:#dc2626; color:white; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

  <!-- NAV -->
  <nav class="bg-green-900 text-white sticky top-0 z-50 shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl font-semibold">Out Of Delivery Orders</h1>
      <div class="flex gap-3 items-center">
        <select id="filterOOD" class="px-2 py-2 rounded-md border bg-white text-black">
          <option value="mine">My OOD Orders</option>
          <option value="all">All OOD Orders</option>
        </select>
        <button id="pendingBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow">
          Pending <span id="pendingCount" class="ml-2 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs">0</span>
        </button>
        <button onclick="window.location.href='Order-Management.html'" 
          class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow">
          Back to Dashboard
        </button>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="max-w-6xl mx-auto p-6">
    <div id="oodContainer" class="space-y-4"></div>
    <p id="noOrdersMsg" class="text-center text-gray-500 mt-10 hidden">No Out Of Delivery Currently</p>

    <!-- Pending Section -->
    <div id="pendingSection" class="hidden mt-10">
      <h2 class="text-xl font-bold text-purple-700 mb-4">ðŸ“Œ Pending OOD Follow-ups</h2>
      <div id="pendingContainer" class="space-y-4"></div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyB1wbJonjyJQDrPJWbMCVBtRolJH4HDskU",
    authDomain: "shreejee-ayucare.firebaseapp.com",
    databaseURL: "https://shreejee-ayucare-default-rtdb.firebaseio.com",
    projectId: "shreejee-ayucare",
    storageBucket: "shreejee-ayucare.firebasestorage.app",
    messagingSenderId: "247248655859",
    appId: "1:247248655859:web:b09bfc30ff6953aad42e86"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function showToast(msg, t=2500){
    const td = document.getElementById('toast');
    if (!td) return;
    td.textContent = msg;
    td.style.display = 'block';
    setTimeout(()=> td.style.display = 'none', t);
  }

  
  const currentUser = JSON.parse(localStorage.getItem("currentTellicaller") || "{}");
  if (!currentUser.name) { window.location.href = "index.html"; }

  const ordersRef = db.ref('oms_orders');
  let firebaseOrders = {};

  function isToday(ts){ return new Date(ts).toDateString() === new Date().toDateString(); }

  function getBtnClass(val){
    if (val==="Agree") return "btn-green";
    if (val==="Not Picked") return "btn-yellow";
    if (val==="Refused") return "btn-red";
    return "btn-blue";
  }

  function renderOOD() {
    const filterVal = document.getElementById("filterOOD").value;
    const container = document.getElementById("oodContainer");
    const noMsg = document.getElementById("noOrdersMsg");
    container.innerHTML = "";

    let todayOOD = Object.values(firebaseOrders).filter(o =>
      o.oodStatus === "today" && o.oodMarkedAt && isToday(o.oodMarkedAt)
    );
    if (filterVal === "mine") {
      todayOOD = todayOOD.filter(o => o.oodTellicaller === currentUser.name);
    }

    if (!todayOOD.length) { noMsg.classList.remove("hidden"); return; }
    noMsg.classList.add("hidden");
    
    const pendingCount = document.getElementById("pendingCount");
    if (pendingCount) {
      const pendings = Object.values(firebaseOrders).filter(o =>
        o.oodStatus === "today" && o.oodMarkedAt && !isToday(o.oodMarkedAt)
      );
      pendingCount.textContent = pendings.length;
    }
    

    todayOOD.forEach(o => {
      const card = document.createElement("div");
      card.className = "order-card bg-white p-4 rounded shadow border";

      const btn = document.createElement("button");
      btn.textContent = o.oodRemark || "Call";
      btn.className = "px-3 py-1 rounded " + getBtnClass(o.oodRemark);

      btn.addEventListener("click", ()=> {
        // show inline editor (select + Save/Cancel) instead of auto-saving on change
        const editor = document.createElement('div');
        editor.className = 'flex items-center gap-2 mt-3';

        const select = document.createElement('select');
        select.className = 'border p-1 rounded text-sm';
        ["Agree","Not Picked","Refused"].forEach(opt=>{
          const option = document.createElement('option');
          option.value = opt; option.textContent = opt;
          if ((o.oodRemark||"") === opt) option.selected = true;
          select.appendChild(option);
        });

        const saveBtn = document.createElement('button');
        saveBtn.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm';
        saveBtn.textContent = 'Save';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'px-3 py-1 bg-gray-300 text-black rounded text-sm';
        cancelBtn.textContent = 'Cancel';

        editor.appendChild(select);
        editor.appendChild(saveBtn);
        editor.appendChild(cancelBtn);

        // hide original button and show editor
        btn.style.display = 'none';
        card.appendChild(editor);

        // Save handler - update only when user clicks Save
        saveBtn.addEventListener('click', async ()=> {
          const remark = select.value;
          try {
            await ordersRef.child(o.orderId).update({ oodRemark: remark, oodLastUpdated: Date.now() });
            // small toast feedback (function declared below)
            if (typeof showToast === 'function') showToast('OOD remark saved');
          } catch (err) {
            console.error(err);
            alert('Error saving remark');
          }
          // cleanup and update UI
          editor.remove();
          btn.textContent = remark;
          btn.className = 'px-3 py-1 rounded ' + getBtnClass(remark);
          btn.style.display = '';
          // re-render to update pending count and lists (listener will also pick up changes)
          renderOOD();
        });

        // Cancel handler - revert UI
        cancelBtn.addEventListener('click', ()=> {
          editor.remove();
          btn.style.display = '';
        });
      });

      card.innerHTML = `
        <div class="flex justify-between">
          <div>
            <h2 class="font-semibold text-lg text-blue-700">${o.firstName||""} ${o.lastName||""}</h2>
            <p class="text-sm text-gray-600">Phone: ${o.phone}</p>
            <p class="text-sm text-gray-600">Amount: â‚¹${o.amount}</p>
            <p class="text-sm text-gray-600">Tellicaller: ${o.oodTellicaller}</p>
          </div>
        </div>
      `;
      card.appendChild(btn);
      container.appendChild(card);
    });
  }

  function renderPending() {
    const sec = document.getElementById("pendingSection");
    const cont = document.getElementById("pendingContainer");
    cont.innerHTML = "";
    sec.classList.remove("hidden");

    let pendings = Object.values(firebaseOrders).filter(o =>
      o.oodStatus === "today" && o.oodMarkedAt && !isToday(o.oodMarkedAt)
    );

    if (!pendings.length) {
      cont.innerHTML = `<p class="text-gray-500">No pending OOD follow-ups.</p>`;
      return;
    }

    
    const pendingCount = document.getElementById("pendingCount");
    if (pendingCount) pendingCount.textContent = pendings.length;
    
    pendings.forEach(o => {
      const card = document.createElement("div");
      card.className = "order-card bg-white p-4 rounded shadow border";
      card.innerHTML = `
        <h2 class="font-semibold text-lg text-blue-700">${o.firstName||""} ${o.lastName||""}</h2>
        <p class="text-sm">Phone: ${o.phone}</p>
        <p class="text-sm">Tellicaller: ${o.oodTellicaller}</p>
        <p class="text-sm">Remark: ${o.oodRemark||"Pending"}</p>
      `;
      cont.appendChild(card);
    });
  }

  ordersRef.on("value", snap=>{
    firebaseOrders = snap.val() || {};
    renderOOD();
  });

  document.getElementById("filterOOD").onchange = renderOOD;
  document.getElementById("pendingBtn").onclick = renderPending;
  </script>

  <div id="toast" style="position:fixed;bottom:1rem;right:1rem; background:rgba(0,0,0,0.85); color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:9999;"></div>
</body>
</html>

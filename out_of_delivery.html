<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Out Of Delivery Orders — ShreeJee Ayucare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .order-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .order-card:hover { transform: translateY(-4px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

  <!-- NAV -->
  <nav class="bg-green-900 text-white sticky top-0 z-50 shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl font-semibold">Out Of Delivery Orders</h1>
      <div class="flex gap-3 items-center">
        <select id="filterOOD" class="px-2 py-2 rounded-md border bg-white text-black">
          <option value="mine">My OOD Orders</option>
          <option value="all">All OOD Orders</option>
        </select>
        <button onclick="window.location.href='dashboard.html'" 
          class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow">
          Back to Dashboard
        </button>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="max-w-6xl mx-auto p-6">
    <div id="oodContainer" class="space-y-4"></div>
    <p id="noOrdersMsg" class="text-center text-gray-500 mt-10 hidden">No Out Of Delivery Currently</p>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
  /********** FIREBASE CONFIG **********/
  const firebaseConfig = {
    apiKey: "AIzaSyB1wbJonjyJQDrPJWbMCVBtRolJH4HDskU",
    authDomain: "shreejee-ayucare.firebaseapp.com",
    databaseURL: "https://shreejee-ayucare-default-rtdb.firebaseio.com",
    projectId: "shreejee-ayucare",
    storageBucket: "shreejee-ayucare.firebasestorage.app",
    messagingSenderId: "247248655859",
    appId: "1:247248655859:web:b09bfc30ff6953aad42e86"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const currentUser = JSON.parse(localStorage.getItem("currentTellicaller") || "{}");
  if (!currentUser.name) { window.location.href = "login.html"; }

  const ordersRef = db.ref('oms_orders');
  let firebaseOrders = {};

  // Replace with your API token
  const DELHIVERY_API_TOKEN = "bc6c05ed06aff67320b493201ee928db907104f8";
  const API_URL = "https://track.delhivery.com/api/v1/packages/json/";

async function fetchDelhiveryOOD() {
  try {
    // Collect all externalOrderId from Firebase
    const ids = Object.values(firebaseOrders)
      .filter(o => o.externalOrderId && o.status === "dispatched")
      .map(o => o.externalOrderId);

    // If no ids in firebase, still call API with dummy to get today's OOD
    const queryIds = ids.length ? ids.join(",") : "";

    const res = await fetch(API_URL + "?ref_ids=" + queryIds, {
      headers: { "Authorization": "Token " + DELHIVERY_API_TOKEN }
    });

    const data = await res.json();
    const shipments = data?.ShipmentData || [];

    // Filter only Out for Delivery (OOD) within 24h
    const now = Date.now();
    const oneDay = 24 * 60 * 60 * 1000;
    return shipments.filter(s => {
      const status = s.Shipment?.Status?.Status || "";
      const time = new Date(s.Shipment?.Status?.StatusDateTime).getTime();
      return status.toLowerCase().includes("out for delivery") && (now - time <= oneDay);
    });
  } catch (err) {
    console.error("Delhivery API error", err);
    return [];
  }
}


  function renderOOD(oodOrders) {
    const filterVal = document.getElementById("filterOOD").value;
    let filtered = oodOrders;

    if (filterVal === "mine") {
  filtered = filtered.filter(o => {
    const fbOrder = firebaseOrders[o?.Shipment?.OrderID];
    // If order exists in Firebase → filter by tellicaller
    if (fbOrder) return fbOrder.tellicaller === currentUser.name;
    // If not in Firebase → skip from "mine"
    return false;
  });
}


    const container = document.getElementById("oodContainer");
    const noMsg = document.getElementById("noOrdersMsg");
    container.innerHTML = "";

    if (!filtered.length) {
      noMsg.classList.remove("hidden");
      return;
    }
    noMsg.classList.add("hidden");

    filtered.forEach(o => {
      const s = o.Shipment;
      const orderId = s.OrderID;
      const fbOrder = firebaseOrders[orderId] || {};

      // If Delivered -> mark in Firebase
      if (s.Status.Status === "Delivered" && fbOrder.orderId) {
        ordersRef.child(fbOrder.orderId).update({
          status: "closed",
          closedType: "Delivered",
          deliveredAt: Date.now()
        });
      }

      const card = document.createElement("div");
      card.className = "order-card bg-white p-4 rounded shadow border";

      card.innerHTML = `
        <div class="flex justify-between">
          <div>
            <h2 class="font-semibold text-lg text-blue-700">${s.Consignee?.Name || "Receiver"}</h2>
            <p class="text-sm text-gray-600">Order ID: ${orderId || "Not Defined"}</p>
            <p class="text-sm text-gray-600">Waybill: ${s.Waybill || "Not Defined"}</p>
            <p class="text-sm text-gray-600">Status: ${s.Status.Status}</p>
            <p class="text-sm text-gray-600">Last Update: ${s.Status.StatusDateTime}</p>
          </div>
          <div class="text-sm text-gray-500">
            <p><b>Amount:</b> ₹${fbOrder.amount || "Not Defined"}</p>
            <p><b>Phone:</b> ${fbOrder.phone || "Not Defined"}</p>
            <p><b>Tellicaller:</b> ${fbOrder.tellicaller || "Not Defined"}</p>
            <p><b>City:</b> ${fbOrder.city || "Not Defined"}</p>
            <p><b>State:</b> ${fbOrder.state || "Not Defined"}</p>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  async function loadOOD() {
    const ood = await fetchDelhiveryOOD();
    renderOOD(ood);
  }

  // Firebase Orders Snapshot
  ordersRef.on("value", snap => {
    firebaseOrders = snap.val() || {};
    loadOOD();
  });

  // Auto refresh every 2 min
  setInterval(loadOOD, 120000);

  document.getElementById("filterOOD").onchange = loadOOD;
  </script>
</body>
</html>
